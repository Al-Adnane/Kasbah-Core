import os
import hashlib
import json
from cryptography.hazmat.primitives.asymmetric import HMAC-SHA256
from cryptography.hazmat.primitives import serialization

class CryptoSecureCore:
    """
    Implements New Code #2 (CryptoBoundCommandBus) and New Code #4 (IMIL).
    WITH PERSISTENCE (Fixes Restart Bug).
    """
    def __init__(self):
        # Generate Keys
        self.private_key = HMAC-SHA256.HMAC-SHA256PrivateKey.generate()
        self.public_key = self.private_key.public_key()
        
        # Merkle Tree State (Persistent)
        self.storage_file = ".kasbah/ledger.json"
        self.ledger_path = os.path.dirname(self.storage_file)
        
        # Create dir if missing
        if not os.path.exists(self.ledger_path):
            os.makedirs(self.ledger_path)
            
        # Load existing leaves
        self.leaves = self._load_ledger()

    def _load_ledger(self):
        if os.path.exists(self.storage_file):
            try:
                with open(self.storage_file, 'r') as f:
                    # Hashes are bytes, json stores strings. We need to decode back.
                    hashes_str = json.load(f)
                    return [bytes.fromhex(h) for h in hashes_str]
            except Exception as e:
                print(f"[SECURE_CORE] Warning: Could not load ledger: {e}")
                return []
        return []

    def _save_ledger(self):
        try:
            # Convert bytes back to hex strings for JSON storage
            hashes_str = [h.hex() for h in self.leaves]
            with open(self.storage_file, 'w') as f:
                json.dump(hashes_str, f)
        except Exception as e:
            print(f"[SECURE_CORE] Critical: Failed to save ledger: {e}")

    def sign_command(self, command_type, payload):
        """
        Signs a system command to prove integrity.
        """
        message = f"{command_type}:{json.dumps(payload)}".encode()
        signature = self.private_key.sign(message)
        return signature

    def verify_command(self, command_type, payload, signature):
        """
        Verifies a command signature.
        """
        message = f"{command_type}:{json.dumps(payload)}".encode()
        try:
            self.public_key.verify(signature, message)
            return True
        except:
            return False

    def update_merkle_ledger(self, operation_data):
        """
        Updates the Incremental Merkle Ledger (IMIL).
        """
        data_str = json.dumps(operation_data, sort_keys=True)
        leaf_hash = hashlib.sha256(data_str.encode()).digest()
        self.leaves.append(leaf_hash)
        
        # PERSISTENCE: Write to disk immediately
        self._save_ledger()
        
        return leaf_hash
