version: '3.8'

services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8002:8002"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - KASBAH_REPLAY_DB=/app/data/rtp_replay.sqlite
      - REDIS_HOST=
      - REDIS_PORT=6379
      - KASBAH_REPLAY_DB=/app/data/rtp_replay.sqlite
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - KASBAH_REPLAY_DB=/app/data/rtp_replay.sqlite
      - KASBAH_GEOMETRY_THRESHOLD=95
      - KASBAH_THRESHOLD_BONUS=-0.30

      - KASBAH_INTEGRITY_THRESHOLD=0.30

      - KASBAH_JWT_SECRET=REMOVED
      - KASBAH_SIGN_MODE=hs256
      - KASBAH_TICKET_TTL_SECONDS=120
      - KASBAH_SYSTEM_STABLE=1
    volumes:
      - .:/app
      - ./.kasbah:/app/.kasbah
      - ./data:/app/data
    command: ["sh","-lc","mkdir -p /app/data && chmod 777 /app/data && exec python -m uvicorn apps.api.main:app --host 0.0.0.0 --port 8002"]